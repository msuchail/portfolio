name: deploy to prod

on:
  push:
    branches:
      - master

jobs:
  deploy:
    environment: prod
    runs-on: "ubuntu-20.04"
    steps:
      - name: Build Docker Image and Push to GHCR, Docker Hub, or AWS ECR
    # You may pin to the exact commit or the version.
    # uses: GlueOps/github-actions-build-push-containers@e131c8e380656eabbe5f6e3c817bf658dc7b3fe5
        uses: GlueOps/github-actions-build-push-containers@v0.4.1
        with:
          # The Dockerfile filename
          dockerfile: ./docker/Dockerfile
          # Personal Access Token (PAT) used to authenticate with the GitHub Container Registry.
          github_token: ${{ secrets.PAT }}

      - name: Run remote command via SSH
        uses: D3rHase/ssh-command-action@latest
        with:
          host: ${{ secrets.SSH_HOST }}
          user: ${{ secrets.SSH_USER }}
          private_key: ${{ secrets.SSH_PRIVATE_KEY }}
          command: |
            cd portfolio
            docker compose pull
            docker compose down
            docker compose up -d

