name: deploy to prod

on:
  push:
    branches:
      - master

jobs:
  deploy:
    environment: prod
    runs-on: "ubuntu-20.04"
    steps:
      - name: Build Docker Image and Push to GHCR, Docker Hub, or AWS ECR
    # You may pin to the exact commit or the version.
    # uses: GlueOps/github-actions-build-push-containers@e131c8e380656eabbe5f6e3c817bf658dc7b3fe5
        uses: GlueOps/github-actions-build-push-containers@v0.4.1
        with:
          # The Dockerfile filename
          dockerfile: ./docker/Dockerfile
          # Personal Access Token (PAT) used to authenticate with the GitHub Container Registry.
          github_token: ${{ secrets.PAT }}

      - name: SSH-Compose
        # You may pin to the exact commit or the version.
        # uses: matiasnu/github-action-ssh-docker-compose@7fb3aa789f898b63c3722e6beb2dafa1a70f0e22
        uses: matiasnu/github-action-ssh-docker-compose@v2.0.3
        with:
          # Private SSH key used for logging into remote system.
          ssh_private_key: ${{ secrets.SSH_PRIVATE_KEY }}
          # Remote host name.
          ssh_host: ${{ secrets.SSH_HOST }}
          # Remote user name.
          ssh_user: ${{ secrets.SSH_USER }}
          # Prefix for docker compose containers.
          docker_compose_prefix: 'portfolio'
          # Docker compose file to use
          docker_compose_filename: 'docker-compose.yml'
          # Execute docker compose-down ("true" or "false").
          docker_compose_down: true

